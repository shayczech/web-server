name: DevSecOps Portfolio CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

# --- PERMISSIONS YOU ADDED FOR OIDC ---
permissions:
  id-token: write  # Allows the job to request an OIDC token
  contents: read   # Allows the job to checkout the code

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Setup Node.js and Install Dependencies for Snyk (No changes) ---
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Node.js Dependencies (for Snyk Scan)
        run: npm install
        working-directory: ansible/files/api/

      # --- Snyk SAST Scan (No changes) ---
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }} 
        with:
          command: monitor ansible/files/api/
          args: --fail-on=high

      - name: Clean up node_modules to prevent Ansible copy hang
        run: rm -rf ansible/files/api/node_modules
        
      # --- OIDC Configuration (No changes) ---
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::643913568924:role/GitHub-Actions-Deploy-Role # Your OIDC Role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActionsSession

      # --- PHASE 1: Terraform (IaC) (No changes) ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: infra/

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve
        working-directory: infra/

      # --- PHASE 2: Ansible (Configuration Management) ---

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install community.docker

      - name: Get EC2 SSH Private Key from AWS Secrets Manager
        id: get_ssh_key
        run: |
          aws secretsmanager get-secret-value \
            --secret-id ec2-ssh-private-key \
            --query SecretString \
            --output text > /tmp/ec2-key.pem
          chmod 600 /tmp/ec2-key.pem

      - name: Get Instance Public IP and Update Inventory
        run: |
          INSTANCE_IP=$(terraform -chdir=../infra output -raw instance_public_ip)
          echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV
          
          # Create inventory file with IP
          echo "[webservers]" > inventory.ini
          echo "$INSTANCE_IP" >> inventory.ini
          
          echo "[all:vars]" >> inventory.ini
          echo "ansible_user=ubuntu" >> inventory.ini
          echo "ansible_ssh_private_key_file=/tmp/ec2-key.pem" >> inventory.ini
          echo "ansible_python_interpreter=/usr/bin/python3" >> inventory.ini
          echo "ansible_become=true" >> inventory.ini
        working-directory: ansible/

      - name: Wait for SSH to be ready
        run: |
          echo "Waiting for SSH on ${INSTANCE_IP}..."
          for i in {1..30}; do
            if ssh -i /tmp/ec2-key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${INSTANCE_IP} echo "SSH Ready"; then
              echo "SSH connection successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "SSH connection failed after 30 attempts"
          exit 1

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini deploy_nginx.yml
        working-directory: ansible/